<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ù…Ø­Ù„ÙŠ - Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„Ø¨Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©">
    <meta name="theme-color" content="#22c55e">
    <title>Ù…Ø­Ù„ÙŠ - Mahali POS</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css?v=9">
</head>
<body>
    <!-- App Root -->
    <div id="app"></div>

    <!-- Preact from CDN (no build tools needed!) -->
    <script type="module" src="js/app.js?v=9"></script>

    <!-- Register Service Worker for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('âœ… Service Worker registered:', reg.scope);

                        // Check for updates periodically (every 5 minutes)
                        setInterval(() => {
                            reg.update();
                        }, 5 * 60 * 1000);

                        // Listen for new service worker waiting
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            console.log('ðŸ”„ New Service Worker found, installing...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available, reload to get it
                                    console.log('âœ… New version available! Reloading...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(err => console.error('âŒ Service Worker registration failed:', err));
            });

            // Listen for messages from service worker (e.g., update notifications)
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SW_UPDATED') {
                    console.log('ðŸ”„ Service Worker updated to:', event.data.version);
                    // Reload to get latest files
                    window.location.reload();
                }
            });

            // Handle controller change (new SW took over)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('ðŸ”„ New Service Worker controlling page, reloading...');
                window.location.reload();
            });
        }

        // Listen for install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('âœ… beforeinstallprompt event fired - App is installable!');
            e.preventDefault();
            deferredPrompt = e;

            // Show install banner after 3 seconds
            setTimeout(() => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('âœ… User accepted the install prompt');
                        } else {
                            console.log('âŒ User dismissed the install prompt');
                        }
                        deferredPrompt = null;
                    });
                }
            }, 3000);
        });

        window.addEventListener('appinstalled', () => {
            console.log('âœ… PWA was installed successfully!');
        });
    </script>
</body>
</html>
